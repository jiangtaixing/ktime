var domApp = document.querySelector(".app");
var domTime = document.querySelector(".time");
var domDate = document.querySelector(".date");
var domCnDate = document.querySelector(".cn-date");
var domStandAlert = document.querySelector(".stand-alert");

function geturl(url) {
  var arr = url.split("?");

  if (!arr[1]) {
    return {};
  }

  var res = arr[1].split("&");
  var items = {};
  for (var i = 0; i < res.length; i++) {
    var a = res[i].split("=");
    items[a[0]] = a[1];
  }
  return items;
}
function formatDate(date, fmt) {
  if (typeof fmt === "undefined") {
    fmt = "yyyy-MM-dd";
  }
  if (!date) {
    return "";
  }
  if (typeof date === "number" || typeof date === "string") {
    date = new Date(Number(date));
  }
  var o = {
    "M+": date.getMonth() + 1,
    "d+": date.getDate(),
    "h+": date.getHours(),
    "m+": date.getMinutes(),
    "s+": date.getSeconds(),
    "q+": Math.floor((date.getMonth() + 3) / 3),
    S: date.getMilliseconds(),
  };
  if (/(y+)/.test(fmt))
    fmt = fmt.replace(
      RegExp.$1,
      (date.getFullYear() + "").substr(4 - RegExp.$1.length)
    );
  for (var k in o)
    if (new RegExp("(" + k + ")").test(fmt))
      fmt = fmt.replace(
        RegExp.$1,
        RegExp.$1.length === 1 ? o[k] : ("00" + o[k]).substr((o[k] + "").length)
      );
  return fmt;
}
function render() {
  try {
    // Kindle浏览器的new Date()通常返回UTC时间，而电脑浏览器返回本地时间（如UTC+8）
    // 智能判断：如果时区偏移量为0（UTC），则手动加8小时；否则信任系统时间
    var now = new Date();
    var offset = now.getTimezoneOffset(); // 分钟，UTC为0，UTC+8为-480
    
    var date;
    if (offset === 0) {
       // Kindle环境：认为是UTC，需要加8小时
       // 根据之前的经验，Kindle可能还有3分钟的额外延迟，这里一并加上
       date = new Date(now.getTime() + (8 * 60 * 60 * 1000) + (3 * 60 * 1000));
    } else {
       // 电脑环境或其他已设置时区的环境：直接使用系统时间
       date = now;
    }
    
    var lunar = calendar.solar2lunar(
      date.getFullYear(),
      date.getMonth() + 1,
      date.getDate()
    );
    
    var dateText = formatDate(date, "yyyy.M.d") + " " + (
      urlQuery.l == "en"
      ? ["SUN", "MON", "TUES", "WED", "THUR", "FRI", "SAT"][date.getDay()]
      : "星期" + ["日", "一", "二", "三", "四", "五", "六"][date.getDay()]
    );
    
    // 修复分钟显示格式，确保两位数显示（兼容老版本浏览器）
    var hours = date.getHours();
    var minutes = date.getMinutes();
    var timeText = hours + ":" + (minutes < 10 ? '0' + minutes : minutes);
    
    var cnDateText = lunar.IMonthCn + lunar.IDayCn + " " + lunar.Animal + "年";

    var standAlertText = "";
    if (hours % 2 !== 0) {
      standAlertText = "现在是站立时间";
    }

    if (domDate && domDate.innerHTML != dateText) domDate.innerHTML = dateText;
    if (domTime && domTime.innerHTML != timeText) domTime.innerHTML = timeText;
    if (domCnDate && domCnDate.innerHTML != cnDateText) domCnDate.innerHTML = cnDateText;
    if (domStandAlert && domStandAlert.innerHTML != standAlertText) domStandAlert.innerHTML = standAlertText;
  } catch (e) {
    // 如果出现错误，至少显示基本时间
    if (domTime) {
      var now = new Date();
      var h = now.getHours();
      var m = now.getMinutes();
      domTime.innerHTML = h + ":" + (m < 10 ? '0' + m : m);
    }
  }
}

var urlQuery = geturl(location.href);
var config = {
  fontSize: +(urlQuery.fs || 7),
  rotate: urlQuery.r,
  lang: urlQuery.l,
};

domTime.style.fontSize = config.fontSize + "rem";
domDate.style.fontSize = config.fontSize / 2.5 + "rem";
domCnDate.style.fontSize = config.fontSize / 4 + "rem";
if (domStandAlert) domStandAlert.style.fontSize = config.fontSize / 4 + "rem";
domApp.style.cssText = "-webkit-transform: rotate(" + (config.rotate || 0) + "deg) translate3d(-50%,-50%,0)";

// 添加版本信息用于调试缓存问题
console.log("Kindle Time Script v2.9 - Smart Timezone Compensation - " + new Date().toISOString());

render();
setInterval(function() {
  render();
}, 1000);